# .ebextensions/python.config

packages:
  yum:
    gcc: []
    gcc-c++: []
    libffi-devel: []
    python3-devel: []
    postgresql-devel: []
    make: []

option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: core/wsgi.py  # relative to deploy root
  aws:elasticbeanstalk:application:environment:
    DJANGO_SETTINGS_MODULE: core.settings
    SECRET_KEY: your_secret_key_here
    DEBUG: 'False'
    ALLOWED_HOSTS: '.elasticbeanstalk.com'

container_commands:

  00_create_db_dir:
    command: |
      echo "Ensuring SQLite database directory exists..."
      mkdir -p /var/app/current/backend
      touch /var/app/current/backend/db.sqlite3

  01_install_dependencies:
    command: |
      echo "Activating virtual environment and installing Python packages..."
      if [ ! -d /var/app/venv ]; then
        python3 -m venv /var/app/venv
      fi
      . /var/app/venv/bin/activate
      pip install --upgrade pip
      if [ -f requirements.txt ]; then
        pip install -r requirements.txt --log /var/log/pip_install.log
      fi
      cat /var/log/pip_install.log

  02_collect_static:
    command: |
      echo "Collecting Django static files..."
      . /var/app/venv/bin/activate
      python manage.py collectstatic --noinput
    leader_only: true

  03_migrate:
    command: |
      echo "Applying Django database migrations..."
      . /var/app/venv/bin/activate
      python manage.py migrate --noinput
    leader_only: true
