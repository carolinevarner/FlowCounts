# .ebextensions/python.config

option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: backend/core/wsgi.py

container_commands:
  00_mkdir_db:
    command: |
      echo "Ensuring SQLite database directory exists..."
      mkdir -p /var/app/current/backend
      touch /var/app/current/backend/db.sqlite3

  01_install_requirements:
    command: |
      echo "Activating virtual environment and installing Python packages..."
      source $(find /var/app/venv -type f -path "*/bin/activate")
      pip install --upgrade pip
      pip install -r requirements.txt --log /var/log/pip_install.log || cat /var/log/pip_install.log

  02_collect_static:
    command: |
      echo "Collecting Django static files..."
      source $(find /var/app/venv -type f -path "*/bin/activate")
      python backend/manage.py collectstatic --noinput
    leader_only: true

  03_migrate:
    command: |
      echo "Applying Django database migrations..."
      source $(find /var/app/venv -type f -path "*/bin/activate")
      python backend/manage.py migrate --noinput
    leader_only: true
